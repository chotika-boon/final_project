import streamlit as st
import pandas as pd
import os

CSV_FILE = "user_data.csv"
CARD_DATA_FILE = "credit_card.csv"

# ---------- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á CSV ----------
def save_to_csv(row, file_path=CSV_FILE):
    df_new = pd.DataFrame([row])
    if not os.path.exists(file_path):
        df_new.to_csv(file_path, index=False)
    else:
        df_existing = pd.read_csv(file_path)
        df_combined = pd.concat([df_existing, df_new], ignore_index=True)
        df_combined.to_csv(file_path, index=False)

# ---------- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥ ----------
def is_duplicate_email(email, file_path=CSV_FILE):
    if not os.path.exists(file_path):
        return False
    df = pd.read_csv(file_path)
    return email in df["email"].values

# ---------- ‡∏´‡∏ô‡πâ‡∏≤ Register ----------
def show_register():
    if "register_visited" not in st.session_state:
        st.session_state.register_visited = True
        st.session_state.credit_cards = []
        st.session_state.card_count = 1

    df = pd.read_csv(CARD_DATA_FILE)

    st.markdown("<h2 style='text-align:center;'>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>", unsafe_allow_html=True)

    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    st.markdown("### üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ")
    col1, col2 = st.columns(2)
    with col1:
        username = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ")
    with col2:
        email = st.text_input("‡∏≠‡∏µ‡πÄ‡∏°‡∏•")

    col1, col2 = st.columns(2)
    with col1:
        password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
    with col2:
        confirm_password = st.text_input("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")

    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° credit card slots
    while len(st.session_state.credit_cards) < st.session_state.card_count:
        st.session_state.credit_cards.append({
            "bank": "",
            "product": "",
            "issuer": ""
        })

    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
    st.markdown("### üí≥ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï")
    remove_index = None

    for i in range(st.session_state.card_count):
        with st.expander(f"üìÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà {i+1}", expanded=True):
            bank_list = sorted(df["‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£"].dropna().unique())
            selected_bank = st.selectbox("üè¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£", options=bank_list, key=f"bank_{i}")

            product_df = df[df["‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£"] == selected_bank]
            product_list = sorted(product_df["‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£"].dropna().unique())
            selected_product = st.selectbox("üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£", options=product_list, key=f"product_{i}")

            issuer_df = product_df[product_df["‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£"] == selected_product]
            issuer_list = sorted(issuer_df["‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£"].dropna().unique())
            selected_issuer = st.selectbox("üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£", options=issuer_list, key=f"issuer_{i}")

            st.session_state.credit_cards[i] = {
                "bank": selected_bank,
                "product": selected_product,
                "issuer": selected_issuer
            }

            if st.session_state.card_count > 1:
                if st.button(f"üóëÔ∏è ‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà {i+1}", key=f"remove_{i}"):
                    remove_index = i

    if remove_index is not None:
        del st.session_state.credit_cards[remove_index]
        st.session_state.card_count -= 1
        st.rerun()

    if st.button("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£"):
        st.session_state.card_count += 1
        st.rerun()

    # ‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    if st.button("‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"):
        if not username or not email or not password:
            st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô")
        elif password != confirm_password:
            st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô")
        elif is_duplicate_email(email):
            st.error("‚ùå ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß")
        else:
            for card in st.session_state.credit_cards:
                row = {
                    "name": username,
                    "email": email,
                    "password": password,
                    "bank": card["bank"],
                    "credit_type": card["issuer"],
                    "credit_name": card["product"],
                    "card_count": st.session_state.card_count
                }
                save_to_csv(row)
            st.success(f"‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {username} üéâ")
            st.session_state.page = "login"
            st.rerun()

    # üîÅ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
    if st.button("üîÅ ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"):
        st.session_state.page = "login"
        st.rerun()
